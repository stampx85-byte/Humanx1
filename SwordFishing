local DrRayLibrary = loadstring(game:HttpGet("https://raw.githubusercontent.com/AZYsGithub/DrRay-UI-Library/main/DrRay.lua"))()
local window = DrRayLibrary:Load("Menu V4 (Fix Holding)", "Default")
local tab = DrRayLibrary.newTab("Main", "rbxassetid://4483345998")

local player = game.Players.LocalPlayer
local _G = getgenv()

_G.FastAttack = false
_G.AutoWarp = false
_G.NeedsPathing = true 
_G.WeaponSize = 10 

local monsterNames = {"Enemy Axe", "Enemy Greatsword", "Enemy"}
local spawnPos = CFrame.new(-4.04957008, 17.6710529, 139.705078)
local walkToPos = Vector3.new(-2.61390543, 17.6538887, 146.964645)

-- ฟังก์ชันหามอนสเตอร์
local function GetTarget()
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if table.find(monsterNames, v.Name) then
            local hum = v:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
                return v
            end
        end
    end
    return nil
end

-- ระบบเช็คการตาย (Heartbeat Check)
task.spawn(function()
    while true do
        task.wait(1)
        if _G.AutoWarp then
            local char = player.Character
            if not char or not char:FindFirstChild("Humanoid") or char.Humanoid.Health <= 0 then
                _G.NeedsPathing = true
            end
        end
    end
end)

-- ลูปการตี + ปรับขนาด (แก้ไขให้ถือของได้)
task.spawn(function()
    while true do
        task.wait()
        if _G.FastAttack then
            pcall(function()
                local char = player.Character
                local tool = char:FindFirstChildOfClass("Tool") -- เช็คเฉพาะของที่ถือในมือ
                local hum = char:FindFirstChildOfClass("Humanoid")
                
                if tool and hum and hum.Health > 0 then
                    -- หยุดอนิเมชั่น
                    for _, track in pairs(hum:GetPlayingAnimationTracks()) do
                        track:Stop(0)
                    end
                    
                    -- ตีรัว
                    tool:Activate()
                    
                    -- ปรับขนาดเฉพาะตอนถือ (Handle)
                    local handle = tool:FindFirstChild("Handle") or tool:FindFirstChildOfClass("Part") or tool:FindFirstChildOfClass("MeshPart")
                    if handle then
                        if handle.Size ~= Vector3.new(_G.WeaponSize, _G.WeaponSize, _G.WeaponSize) then
                            handle.Size = Vector3.new(_G.WeaponSize, _G.WeaponSize, _G.WeaponSize)
                        end
                        handle.CanCollide = false
                        handle.Massless = true
                        handle.Transparency = 0
                        
                        -- ระบบดาเมจจริง
                        local target = GetTarget()
                        if target then
                            firetouchinterest(target.HumanoidRootPart, handle, 0)
                            firetouchinterest(target.HumanoidRootPart, handle, 1)
                        end
                    end
                end
            end)
        end
    end
end)

-- ลูปการวาร์ปวนลูป
task.spawn(function()
    while true do
        task.wait(0.1)
        if _G.AutoWarp then
            pcall(function()
                local char = player.Character
                local root = char:FindFirstChild("HumanoidRootPart")
                local hum = char:FindFirstChildOfClass("Humanoid")

                if root and hum and hum.Health > 0 then
                    if _G.NeedsPathing then
                        root.CFrame = spawnPos
                        task.wait(0.5)
                        hum:MoveTo(walkToPos)
                        
                        local t = 0
                        while (root.Position - walkToPos).Magnitude > 5 and t < 8 do
                            task.wait(0.1)
                            t = t + 0.1
                        end
                        
                        task.wait(5)
                        _G.NeedsPathing = false
                    end

                    if not _G.NeedsPathing then
                        local target = GetTarget()
                        if target then
                            root.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, 7, 0)
                        end
                    end
                end
            end)
        end
    end
end)

--- [ UI Control ] ---

tab.newToggle("Fast Attack", "ตีรัว + ถือของได้ปกติ", false, function(state)
    _G.FastAttack = state
end)

tab.newInput("Weapon Size", "ใส่ขนาดดาว (Max 1,000,000)", function(value)
    local num = tonumber(value)
    if num then _G.WeaponSize = math.min(num, 1000000) end
end)

tab.newToggle("Auto Farm (วนลูป)", "เริ่มระบบฟาร์ม", false, function(state)
    _G.AutoWarp = state
    _G.NeedsPathing = true
end)

tab.newButton("Catch Fishing", "ตกปลา 1000 รอบ", function()
    local char = player.Character
    local tool = char and char:FindFirstChildOfClass("Tool")
    if tool and tool:FindFirstChild("RodEvent") then
        for i = 1, 1000 do
            tool.RodEvent:FireServer({ action = "Catch" })
        end
    end
end)
