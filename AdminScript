local player = game.Players.LocalPlayer
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local task = task
local camera = workspace.CurrentCamera

-- === Settings ===
local SPAWN_ANIM_ID = "rbxassetid://126663872512408"
local IDLE_ID = "rbxassetid://115485274167727" 
local WALK_ID = "rbxassetid://113076603308515" 
local NORMAL_FOV = 70
local ZOOM_FOV = 40
local TWEEN_TIME = 0.8
local CAMERA_DISTANCE = 8 

local SOUND_1 = "101197590188807"
local SOUND_2 = "101197590188807"

local isAnimationPlaying = false
local hasDiedBefore = false 

-- === Animation Controller Variables ===
local idleTrack, walkTrack
local moveConnection -- เก็บการเชื่อมต่อไว้เพื่อยกเลิกตอนตาย

-- === [UPGRADED] Epic Dark & Purple Aura Effect ===
local function createSmokeEffect(rootPart)
    local attachment = Instance.new("Attachment", rootPart)
    attachment.Position = Vector3.new(0, -3, 0)
    
    local smoke = Instance.new("ParticleEmitter")
    smoke.Name = "SpawnSmoke"
    smoke.Texture = "rbxassetid://243098098"
    smoke.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(70, 0, 130)), 
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))
    })
    smoke.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.2, 0.2),
        NumberSequenceKeypoint.new(1, 1)
    })
    smoke.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 5),
        NumberSequenceKeypoint.new(1, 15)
    })
    smoke.Lifetime = NumberRange.new(1.5, 2.5)
    smoke.Rate = 120
    smoke.Speed = NumberRange.new(8, 20)
    smoke.SpreadAngle = Vector2.new(0, 360)
    smoke.Parent = attachment

    local embers = Instance.new("ParticleEmitter")
    embers.Texture = "rbxassetid://6020473016"
    embers.Color = ColorSequence.new(Color3.fromRGB(180, 100, 255))
    embers.Size = NumberSequence.new(0.3, 0)
    embers.Lifetime = NumberRange.new(1, 2)
    embers.Rate = 50
    embers.Speed = NumberRange.new(10, 25)
    embers.VelocitySpread = 180
    embers.Parent = attachment

    local energy = Instance.new("ParticleEmitter")
    energy.Name = "VoidEnergy"
    energy.Texture = "rbxassetid://6025070858" 
    energy.Color = ColorSequence.new(Color3.fromRGB(120, 0, 255))
    energy.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.5, 0.4),
        NumberSequenceKeypoint.new(1, 1)
    })
    energy.Size = NumberSequence.new(4, 10)
    energy.Lifetime = NumberRange.new(1)
    energy.Rate = 25
    energy.Speed = NumberRange.new(5, 10)
    energy.Parent = attachment

    task.spawn(function()
        for i = 1, 10 do
            camera.CFrame = camera.CFrame * CFrame.new(math.random(-2,2)/10, math.random(-2,2)/10, math.random(-2,2)/10)
            task.wait(0.05)
        end
    end)
    
    task.spawn(function()
        repeat task.wait(0.1) until isAnimationPlaying == false
        smoke.Enabled = false
        embers.Enabled = false
        energy.Enabled = false
        task.wait(2.5) 
        attachment:Destroy()
    end)
end

-- === UI Setup ===
local function createCinematicUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "CinematicBars"
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = player.PlayerGui
    
    local topBar = Instance.new("Frame", screenGui)
    topBar.BackgroundColor3 = Color3.new(0, 0, 0)
    topBar.BorderSizePixel = 0
    topBar.Size = UDim2.new(1.2, 0, 0.15, 0)
    topBar.Position = UDim2.new(-0.1, 0, -0.2, 0)
    
    local bottomBar = Instance.new("Frame", screenGui)
    bottomBar.BackgroundColor3 = Color3.new(0, 0, 0)
    bottomBar.BorderSizePixel = 0
    bottomBar.Size = UDim2.new(1.2, 0, 0.15, 0)
    bottomBar.Position = UDim2.new(-0.1, 0, 1.1, 0)

    local textLabel = Instance.new("TextLabel", bottomBar)
    textLabel.Size = UDim2.new(0.8, 0, 0.6, 0)
    textLabel.Position = UDim2.new(0.1, 0, 0.2, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(200, 0, 0) 
    textLabel.Font = Enum.Font.Michroma 
    textLabel.TextScaled = true
    textLabel.Text = ""
    
    local uiStroke = Instance.new("UIStroke", textLabel)
    uiStroke.Thickness = 2.5
    uiStroke.Color = Color3.new(0, 0, 0)
    uiStroke.Transparency = 0.3
    
    return screenGui, topBar, bottomBar, textLabel
end

local function typeWrite(label, text)
    label.Text = ""
    for i = 1, #text do
        label.Text = string.sub(text, 1, i)
        task.wait(0.06) 
    end
end

local function stopRadioSound()
    pcall(function() workspace.DRadio_Script.STOPEvent:FireServer() end)
end

local function playRadioSound(id)
    pcall(function()
        workspace.DRadio_Script.STOPEvent:FireServer()
        workspace.DRadio_Script.Event:FireServer(id)
        game:GetService("ReplicatedStorage").Search_Audio:InvokeServer(id)
        workspace.Boards.SettingsHandler.Retriever:InvokeServer("Authenticate")
    end)
end

local function handleAudioSequence()
    local tempSound = Instance.new("Sound")
    tempSound.SoundId = "rbxassetid://" .. SOUND_1
    playRadioSound(SOUND_1)

    task.spawn(function()
        if not tempSound.IsLoaded then tempSound.Loaded:Wait() end
        local duration = tempSound.TimeLength
        local elapsed = 0
        while elapsed < duration and isAnimationPlaying do
            task.wait(0.1)
            elapsed = elapsed + 0.1
        end
        stopRadioSound()
        tempSound:Destroy()
        if isAnimationPlaying then
            task.wait(2)
            if isAnimationPlaying then playRadioSound(SOUND_2) end
        end
    end)
end

local function tweenCinematic(gui, top, bottom, state)
    local targetTop = state and UDim2.new(-0.1, 0, 0, 0) or UDim2.new(-0.1, 0, -0.2, 0)
    local targetBottom = state and UDim2.new(-0.1, 0, 0.85, 0) or UDim2.new(-0.1, 0, 1.1, 0)
    local targetFOV = state and ZOOM_FOV or NORMAL_FOV
    
    local targetExposure = state and -2.5 or 0 
    local targetContrast = state and 0.5 or 0 
    
    local info = TweenInfo.new(TWEEN_TIME, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    TweenService:Create(top, info, {Position = targetTop}):Play()
    TweenService:Create(bottom, info, {Position = targetBottom}):Play()
    TweenService:Create(camera, info, {FieldOfView = targetFOV}):Play()
    
    local cc = Lighting:FindFirstChild("BossEffect") or Instance.new("ColorCorrectionEffect", Lighting)
    cc.Name = "BossEffect"
    
    TweenService:Create(Lighting, info, {ExposureCompensation = targetExposure}):Play()
    TweenService:Create(cc, info, {Contrast = targetContrast, Saturation = state and -0.4 or 0}):Play()
    
    if not state then
        task.delay(TWEEN_TIME, function() 
            if gui and gui.Parent then gui:Destroy() end 
        end)
    end
end

-- === Animation Handler (Updated for Reset) ===
local function setupMovementAnimations(humanoid, animator)
    -- ยกเลิก Connection เก่าถ้ามี
    if moveConnection then moveConnection:Disconnect() end
    
    local idleAnim = Instance.new("Animation")
    idleAnim.AnimationId = IDLE_ID
    local walkAnim = Instance.new("Animation")
    walkAnim.AnimationId = WALK_ID
    
    idleTrack = animator:LoadAnimation(idleAnim)
    walkTrack = animator:LoadAnimation(walkAnim)
    
    moveConnection = RunService.RenderStepped:Connect(function()
        if not humanoid or humanoid.Health <= 0 then 
            if idleTrack then idleTrack:Stop() end
            if walkTrack then walkTrack:Stop() end
            return 
        end
        
        if isAnimationPlaying then 
            if idleTrack.IsPlaying then idleTrack:Stop() end
            if walkTrack.IsPlaying then walkTrack:Stop() end
            return 
        end
        
        if humanoid.MoveDirection.Magnitude == 0 then
            if not idleTrack.IsPlaying then
                walkTrack:Stop()
                idleTrack:Play()
            end
        else
            if not walkTrack.IsPlaying then
                idleTrack:Stop()
                walkTrack:Play()
            end
        end
    end)
end

local function playSpawnAnimation(character)
    isAnimationPlaying = true
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local head = character:WaitForChild("Head")
    local animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

    -- หยุดอนิเมชั่นเก่าที่อาจค้างอยู่
    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
        track:Stop(0)
    end

    -- ปิด Animate เดิม
    local animate = character:FindFirstChild("Animate")
    if animate then animate.Disabled = true end

    -- โหลดท่าทางเดิน/ยืนใหม่
    setupMovementAnimations(humanoid, animator)
    
    -- === เอฟเฟกต์ตาแดง ===
    local eyeAttachment = Instance.new("Attachment", head)
    eyeAttachment.Name = "EyeAttachment"
    
    local eyeLight = Instance.new("PointLight", eyeAttachment)
    eyeLight.Color = Color3.fromRGB(255, 0, 0)
    eyeLight.Brightness = 5
    eyeLight.Range = 5
    eyeLight.Enabled = true

    local function createEyeGlow(offset)
        local bg = Instance.new("BillboardGui", eyeAttachment)
        bg.Size = UDim2.new(1.5, 0, 1.5, 0)
        bg.AlwaysOnTop = true
        bg.ExtentsOffset = offset
        local img = Instance.new("ImageLabel", bg)
        img.BackgroundTransparency = 1
        img.Size = UDim2.new(1, 0, 1, 0)
        img.Image = "rbxassetid://6020473016" 
        img.ImageColor3 = Color3.fromRGB(255, 0, 0)
        return bg
    end

    local leftEye = createEyeGlow(Vector3.new(-0.2, 0.1, -0.55))
    local rightEye = createEyeGlow(Vector3.new(0.2, 0.1, -0.55))

    humanoid.WalkSpeed = 0
    rootPart.Anchored = true 

    local gui, top, bottom, textLabel = createCinematicUI()
    tweenCinematic(gui, top, bottom, true)
    
    task.wait(0.5) 

    handleAudioSequence()
    createSmokeEffect(rootPart)

    local message = hasDiedBefore and "ความตาย... ไม่ใช่จุดจบของข้า!" or "เจ้าคิดว่าจะหนีพ้นความมืดได้งั้นหรอ?"
    task.spawn(function()
        task.wait(TWEEN_TIME) 
        typeWrite(textLabel, message)
    end)

    local spawnAnim = Instance.new("Animation")
    spawnAnim.AnimationId = SPAWN_ANIM_ID
    local spawnTrack = animator:LoadAnimation(spawnAnim)
    spawnTrack.Looped = false
    spawnTrack.Priority = Enum.AnimationPriority.Action

    spawnTrack:Play()
    camera.CameraType = Enum.CameraType.Scriptable
    
    local updateConnection
    updateConnection = RunService.RenderStepped:Connect(function()
        if spawnTrack.IsPlaying and humanoid.Health > 0 then
            local lookAtPos = head.Position
            local camPos = (rootPart.CFrame * CFrame.new(math.sin(tick())*0.2, 1.5, -CAMERA_DISTANCE)).Position
            camera.CFrame = CFrame.new(camPos, lookAtPos)
        else
            updateConnection:Disconnect()
            isAnimationPlaying = false 
            stopRadioSound()
            
            if eyeAttachment then eyeAttachment:Destroy() end
            
            camera.CameraType = Enum.CameraType.Custom
            tweenCinematic(gui, top, bottom, false)
            
            if humanoid.Health > 0 then
                humanoid.WalkSpeed = 16
                humanoid.JumpHeight = 7.2
                rootPart.Anchored = false
                hasDiedBefore = true 
            end
        end
    end)

    task.spawn(function()
        while spawnTrack.IsPlaying and humanoid.Health > 0 do
            task.wait(math.random(1, 3)/10)
            if spawnTrack.IsPlaying then
                spawnTrack:AdjustSpeed(0.2) 
                task.wait(0.1)
                spawnTrack:AdjustSpeed(1)
            end
        end
    end)
end

-- === Core Connections ===
if player.Character then playSpawnAnimation(player.Character) end
player.CharacterAdded:Connect(function(character) 
    playSpawnAnimation(character) 
end)

-- ล้างค่าเมื่อตาย (Cleanup)
player.CharacterRemoving:Connect(function()
    if moveConnection then moveConnection:Disconnect() end
    isAnimationPlaying = false
    stopRadioSound()
end)
