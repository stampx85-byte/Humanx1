local player = game.Players.LocalPlayer
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local task = task
local camera = workspace.CurrentCamera

-- === Settings ===
local SPAWN_ANIM_ID = "rbxassetid://126663872512408"
local IDLE_ID = "rbxassetid://115485274167727" 
local WALK_ID = "rbxassetid://113076603308515" 
local NORMAL_FOV = 70
local ZOOM_FOV = 40
local TWEEN_TIME = 0.8
local CAMERA_DISTANCE = 8 

-- [เพิ่มระบบโหลด Data]
local SOUND_1 = player:GetAttribute("SavedBossSound") or "101197590188807" -- ดึงค่าที่เซฟไว้ ถ้าไม่มีให้ใช้ค่าเริ่มต้น

local isAnimationPlaying = false
local hasDiedBefore = false 

-- === Audio Control Variables (New) ===
local isMusicEnabled = true

-- === Animation Controller Variables ===
local idleTrack, walkTrack
local moveConnection 

-- === UI Creation (Boss Style & Minimize System) ===
local function createAudioControlUI()
    local sg = Instance.new("ScreenGui", player.PlayerGui)
    sg.Name = "AudioSettingsUI"
    sg.ResetOnSpawn = false

    -- Main Container
    local mainFrame = Instance.new("Frame", sg)
    mainFrame.Size = UDim2.new(0, 250, 0, 120)
    mainFrame.Position = UDim2.new(0, 15, 0.5, -60)
    mainFrame.BackgroundColor3 = Color3.fromRGB(10, 0, 0)
    mainFrame.BackgroundTransparency = 0.2
    mainFrame.BorderSizePixel = 0
    Instance.new("UICorner", mainFrame)
    
    local stroke = Instance.new("UIStroke", mainFrame)
    stroke.Color = Color3.fromRGB(255, 0, 0)
    stroke.Thickness = 2

    -- Minimize Button
    local minBtn = Instance.new("TextButton", sg)
    minBtn.Size = UDim2.new(0, 30, 0, 30)
    minBtn.Position = UDim2.new(0, 15, 0.5, -95)
    minBtn.Text = "X"
    minBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    minBtn.TextColor3 = Color3.new(1, 1, 1)
    minBtn.Font = Enum.Font.SpecialElite
    Instance.new("UICorner", minBtn)

    local isMinimized = false
    minBtn.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        mainFrame.Visible = not isMinimized
        minBtn.Text = isMinimized and "+" or "X"
        minBtn.BackgroundColor3 = isMinimized and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    -- Character Portrait (Viewport)
    local portraitFrame = Instance.new("Frame", mainFrame)
    portraitFrame.Size = UDim2.new(0, 70, 0, 70)
    portraitFrame.Position = UDim2.new(0, 10, 0, 10)
    portraitFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Instance.new("UICorner", portraitFrame).CornerRadius = UDim.new(1, 0)
    Instance.new("UIStroke", portraitFrame).Color = Color3.fromRGB(255, 0, 0)

    local viewport = Instance.new("ViewportFrame", portraitFrame)
    viewport.Size = UDim2.new(1, 0, 1, 0)
    viewport.BackgroundTransparency = 1

    local function updateViewport()
        viewport:ClearAllChildren()
        local char = player.Character or player.CharacterAdded:Wait()
        char.Archivable = true
        local clone = char:Clone()
        clone.Parent = viewport
        local vCam = Instance.new("Camera")
        vCam.CFrame = CFrame.new(clone.Head.Position + (clone.Head.CFrame.LookVector * 2.5), clone.Head.Position)
        viewport.CurrentCamera = vCam
        vCam.Parent = viewport
    end
    updateViewport()
    player.CharacterAdded:Connect(updateViewport)

    -- Inputs and Buttons
    local idInput = Instance.new("TextBox", mainFrame)
    idInput.Size = UDim2.new(0, 150, 0, 25)
    idInput.Position = UDim2.new(0, 90, 0, 15)
    idInput.PlaceholderText = "BOSS SOUND ID..."
    idInput.Text = SOUND_1
    idInput.BackgroundColor3 = Color3.fromRGB(40, 0, 0)
    idInput.TextColor3 = Color3.new(1, 1, 1)
    idInput.Font = Enum.Font.SpecialElite
    Instance.new("UICorner", idInput)

    local saveBtn = Instance.new("TextButton", mainFrame)
    saveBtn.Size = UDim2.new(0, 70, 0, 35)
    saveBtn.Position = UDim2.new(0, 90, 0, 50)
    saveBtn.Text = "SAVE"
    saveBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
    saveBtn.TextColor3 = Color3.new(1, 1, 1)
    saveBtn.Font = Enum.Font.SpecialElite
    Instance.new("UICorner", saveBtn)

    local toggleBtn = Instance.new("TextButton", mainFrame)
    toggleBtn.Size = UDim2.new(0, 70, 0, 35)
    toggleBtn.Position = UDim2.new(0, 170, 0, 50)
    toggleBtn.Text = "ON"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.Font = Enum.Font.SpecialElite
    Instance.new("UICorner", toggleBtn)

    local bossLabel = Instance.new("TextLabel", mainFrame)
    bossLabel.Size = UDim2.new(0, 230, 0, 20)
    bossLabel.Position = UDim2.new(0, 10, 0, 90)
    bossLabel.Text = "LORD: " .. player.Name:upper()
    bossLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    bossLabel.BackgroundTransparency = 1
    bossLabel.Font = Enum.Font.SpecialElite
    bossLabel.TextXAlignment = Enum.TextXAlignment.Left

    saveBtn.MouseButton1Click:Connect(function()
        SOUND_1 = idInput.Text
        -- [เพิ่มส่วนการบันทึกลง Data]
        player:SetAttribute("SavedBossSound", SOUND_1) 
        
        saveBtn.Text = "SAVED"
        task.wait(1)
        saveBtn.Text = "SAVE"
    end)

    toggleBtn.MouseButton1Click:Connect(function()
        isMusicEnabled = not isMusicEnabled
        if isMusicEnabled then
            toggleBtn.Text = "ON"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
        else
            toggleBtn.Text = "OFF"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
            pcall(function() workspace.DRadio_Script.STOPEvent:FireServer() end)
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local s = player.Character.HumanoidRootPart:FindFirstChild("BackupIntroSound")
                if s then s:Stop() end
            end
        end
    end)
end

-- เรียกใช้ UI
createAudioControlUI()

-- === Effect Functions ===
local function createSmokeEffect(rootPart)
    local attachment = Instance.new("Attachment", rootPart)
    attachment.Position = Vector3.new(0, -3, 0)
    
    local smoke = Instance.new("ParticleEmitter")
    smoke.Name = "SpawnSmoke"
    smoke.Texture = "rbxassetid://243098098"
    smoke.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 0, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(70, 0, 130)), 
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))
    })
    smoke.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.2, 0.2),
        NumberSequenceKeypoint.new(1, 1)
    })
    smoke.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 5),
        NumberSequenceKeypoint.new(1, 15)
    })
    smoke.Lifetime = NumberRange.new(1.5, 2.5)
    smoke.Rate = 120
    smoke.Speed = NumberRange.new(8, 20)
    smoke.SpreadAngle = Vector2.new(0, 360)
    smoke.Parent = attachment

    local embers = Instance.new("ParticleEmitter")
    embers.Texture = "rbxassetid://6020473016"
    embers.Color = ColorSequence.new(Color3.fromRGB(180, 100, 255))
    embers.Size = NumberSequence.new(0.3, 0)
    embers.Lifetime = NumberRange.new(1, 2)
    embers.Rate = 50
    embers.Speed = NumberRange.new(10, 25)
    embers.VelocitySpread = 180
    embers.Parent = attachment

    local energy = Instance.new("ParticleEmitter")
    energy.Name = "VoidEnergy"
    energy.Texture = "rbxassetid://6025070858" 
    energy.Color = ColorSequence.new(Color3.fromRGB(120, 0, 255))
    energy.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.5, 0.4),
        NumberSequenceKeypoint.new(1, 1)
    })
    energy.Size = NumberSequence.new(4, 10)
    energy.Lifetime = NumberRange.new(1)
    energy.Rate = 25
    energy.Speed = NumberRange.new(5, 10)
    energy.Parent = attachment

    task.spawn(function()
        for i = 1, 10 do
            camera.CFrame = camera.CFrame * CFrame.new(math.random(-2,2)/10, math.random(-2,2)/10, math.random(-2,2)/10)
            task.wait(0.05)
        end
    end)
    
    task.spawn(function()
        repeat task.wait(0.1) until isAnimationPlaying == false
        smoke.Enabled = false
        embers.Enabled = false
        energy.Enabled = false
        task.wait(2.5) 
        attachment:Destroy()
    end)
end

local function createCinematicUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "CinematicBars"
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = player.PlayerGui
    
    local topBar = Instance.new("Frame", screenGui)
    topBar.BackgroundColor3 = Color3.new(0, 0, 0)
    topBar.BorderSizePixel = 0
    topBar.Size = UDim2.new(1.2, 0, 0.15, 0)
    topBar.Position = UDim2.new(-0.1, 0, -0.2, 0)
    
    local bottomBar = Instance.new("Frame", screenGui)
    bottomBar.BackgroundColor3 = Color3.new(0, 0, 0)
    bottomBar.BorderSizePixel = 0
    bottomBar.Size = UDim2.new(1.2, 0, 0.15, 0)
    bottomBar.Position = UDim2.new(-0.1, 0, 1.1, 0)

    local textLabel = Instance.new("TextLabel", bottomBar)
    textLabel.Size = UDim2.new(0.8, 0, 0.6, 0)
    textLabel.Position = UDim2.new(0.1, 0, 0.2, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(200, 0, 0) 
    textLabel.Font = Enum.Font.Michroma 
    textLabel.TextScaled = true
    textLabel.Text = ""
    
    local uiStroke = Instance.new("UIStroke", textLabel)
    uiStroke.Thickness = 2.5
    uiStroke.Color = Color3.new(0, 0, 0)
    uiStroke.Transparency = 0.3
    
    return screenGui, topBar, bottomBar, textLabel
end

local function typeWrite(label, text)
    label.Text = ""
    for i = 1, #text do
        label.Text = string.sub(text, 1, i)
        task.wait(0.06) 
    end
end

-- === Hybrid Audio System ===
local function handleAudioSequence(id, rootPart)
    if not isMusicEnabled then return end -- เพิ่มเช็คสถานะเปิด/ปิดเสียง

    -- 1. พยายามใช้ Remote ของแมพ (ถ้ามี)
    pcall(function()
        workspace.DRadio_Script.STOPEvent:FireServer()
        workspace.DRadio_Script.Event:FireServer(id)
        game:GetService("ReplicatedStorage").Search_Audio:InvokeServer(id)
        workspace.Boards.SettingsHandler.Retriever:InvokeServer("Authenticate")
    end)

    -- 2. สร้างเสียงสำรองแบบ Local
    local localSound = Instance.new("Sound")
    localSound.Name = "BackupIntroSound"
    localSound.SoundId = "rbxassetid://" .. id
    localSound.Volume = 2
    localSound.Parent = rootPart
    
    if not localSound.IsLoaded then localSound.Loaded:Wait() end
    localSound:Play()

    task.spawn(function()
        localSound.Ended:Wait()
        localSound:Destroy()
    end)
end

local function tweenCinematic(gui, top, bottom, state)
    local targetTop = state and UDim2.new(-0.1, 0, 0, 0) or UDim2.new(-0.1, 0, -0.2, 0)
    local targetBottom = state and UDim2.new(-0.1, 0, 0.85, 0) or UDim2.new(-0.1, 0, 1.1, 0)
    local targetFOV = state and ZOOM_FOV or NORMAL_FOV
    
    local targetExposure = state and -2.5 or 0 
    local targetContrast = state and 0.5 or 0 
    
    local info = TweenInfo.new(TWEEN_TIME, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    TweenService:Create(top, info, {Position = targetTop}):Play()
    TweenService:Create(bottom, info, {Position = targetBottom}):Play()
    TweenService:Create(camera, info, {FieldOfView = targetFOV}):Play()
    
    local cc = Lighting:FindFirstChild("BossEffect") or Instance.new("ColorCorrectionEffect", Lighting)
    cc.Name = "BossEffect"
    
    TweenService:Create(Lighting, info, {ExposureCompensation = targetExposure}):Play()
    TweenService:Create(cc, info, {Contrast = targetContrast, Saturation = state and -0.4 or 0}):Play()
    
    if not state then
        task.delay(TWEEN_TIME, function() 
            if gui and gui.Parent then gui:Destroy() end 
        end)
    end
end

local function setupMovementAnimations(humanoid, animator)
    if moveConnection then moveConnection:Disconnect() end
    
    local idleAnim = Instance.new("Animation")
    idleAnim.AnimationId = IDLE_ID
    local walkAnim = Instance.new("Animation")
    walkAnim.AnimationId = WALK_ID
    
    idleTrack = animator:LoadAnimation(idleAnim)
    walkTrack = animator:LoadAnimation(walkAnim)
    
    moveConnection = RunService.RenderStepped:Connect(function()
        if not humanoid or humanoid.Health <= 0 then 
            if idleTrack then idleTrack:Stop() end
            if walkTrack then walkTrack:Stop() end
            return 
        end
        
        if isAnimationPlaying then return end
        
        if humanoid.MoveDirection.Magnitude == 0 then
            if not idleTrack.IsPlaying then
                walkTrack:Stop()
                idleTrack:Play()
            end
        else
            if not walkTrack.IsPlaying then
                idleTrack:Stop()
                walkTrack:Play()
            end
        end
    end)
end

local function playSpawnAnimation(character)
    isAnimationPlaying = true
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local head = character:WaitForChild("Head")
    local animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
        track:Stop(0)
    end

    local animate = character:FindFirstChild("Animate")
    if animate then animate.Disabled = true end

    setupMovementAnimations(humanoid, animator)
    
    local eyeAttachment = Instance.new("Attachment", head)
    eyeAttachment.Name = "EyeAttachment"
    local eyeLight = Instance.new("PointLight", eyeAttachment)
    eyeLight.Color = Color3.fromRGB(255, 0, 0)
    eyeLight.Brightness = 5
    eyeLight.Range = 5

    local function createEyeGlow(offset)
        local bg = Instance.new("BillboardGui", eyeAttachment)
        bg.Size = UDim2.new(1.5, 0, 1.5, 0)
        bg.AlwaysOnTop = true
        bg.ExtentsOffset = offset
        local img = Instance.new("ImageLabel", bg)
        img.BackgroundTransparency = 1
        img.Size = UDim2.new(1, 0, 1, 0)
        img.Image = "rbxassetid://6020473016" 
        img.ImageColor3 = Color3.fromRGB(255, 0, 0)
        return bg
    end

    createEyeGlow(Vector3.new(-0.2, 0.1, -0.55))
    createEyeGlow(Vector3.new(0.2, 0.1, -0.55))

    humanoid.WalkSpeed = 0
    rootPart.Anchored = true 

    local gui, top, bottom, textLabel = createCinematicUI()
    tweenCinematic(gui, top, bottom, true)
    
    task.wait(0.5) 

    handleAudioSequence(SOUND_1, rootPart)
    createSmokeEffect(rootPart)

    local message = hasDiedBefore and "ความตาย... ไม่ใช่จุดจบของข้า!" or "เจ้าคิดว่าจะหนีพ้นความมืดได้งั้นหรอ?"
    task.spawn(function()
        task.wait(TWEEN_TIME) 
        typeWrite(textLabel, message)
    end)

    local spawnAnim = Instance.new("Animation")
    spawnAnim.AnimationId = SPAWN_ANIM_ID
    local spawnTrack = animator:LoadAnimation(spawnAnim)
    spawnTrack.Looped = false
    spawnTrack.Priority = Enum.AnimationPriority.Action
    spawnTrack:Play()

    camera.CameraType = Enum.CameraType.Scriptable
    
    local updateConnection
    updateConnection = RunService.RenderStepped:Connect(function()
        if spawnTrack.IsPlaying and humanoid.Health > 0 then
            local lookAtPos = head.Position
            local camPos = (rootPart.CFrame * CFrame.new(math.sin(tick())*0.2, 1.5, -CAMERA_DISTANCE)).Position
            camera.CFrame = CFrame.new(camPos, lookAtPos)
        else
            updateConnection:Disconnect()
            isAnimationPlaying = false 
            
            if eyeAttachment then eyeAttachment:Destroy() end
            camera.CameraType = Enum.CameraType.Custom
            tweenCinematic(gui, top, bottom, false)
            
            if humanoid.Health > 0 then
                humanoid.WalkSpeed = 16
                humanoid.JumpHeight = 7.2
                rootPart.Anchored = false
                hasDiedBefore = true 
            end
        end
    end)
end

-- === Core Connections ===
if player.Character then playSpawnAnimation(player.Character) end
player.CharacterAdded:Connect(function(character) 
    -- [โหลด ID ล่าสุดจาก Data ก่อนเริ่มแอนิเมชั่น]
    SOUND_1 = player:GetAttribute("SavedBossSound") or SOUND_1
    playSpawnAnimation(character) 
end)

player.CharacterRemoving:Connect(function()
    if moveConnection then moveConnection:Disconnect() end
    isAnimationPlaying = false
    pcall(function() workspace.DRadio_Script.STOPEvent:FireServer() end)
end)
