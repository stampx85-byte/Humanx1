-- [[ ⚡ GASTER BLASTER SYSTEM (BONE ATTACK VERSION) ⚡ ]]

local player = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")
local PlayerGui = player:WaitForChild("PlayerGui")

-- === [ ระบบเสียง ] ===
local function PlayMusic(id) 
    pcall(function() workspace.DRadio_Script.Event:FireServer(tostring(id)) end)
end

local function StopMusic() 
    pcall(function() workspace.DRadio_Script.STOPEvent:FireServer() end)
end

-- === [ ระบบสร้างกระดูก (Bone Effect) ] ===
local function SummonBone(targetHRP)
    if not targetHRP then return end
    
    -- สร้างพาร์ทกระดูก
    local bone = Instance.new("Part")
    bone.Size = Vector3.new(0.5, 5, 0.5) -- ทรงกระดูกแท่งยาว
    bone.BrickColor = BrickColor.new("White")
    bone.Material = Enum.Material.Neon
    bone.CanCollide = false
    bone.Anchored = true
    bone.Name = "SansBone"
    
    -- สุ่มตำแหน่งเกิดรอบๆ เป้าหมาย หรือเกิดจากทิศทางของผู้เล่น
    local startPos = player.Character.HumanoidRootPart.CFrame * CFrame.new(math.random(-10,10), math.random(-5,5), -5).p
    bone.Position = startPos
    bone.CFrame = CFrame.lookAt(bone.Position, targetHRP.Position) * CFrame.Angles(math.rad(90), 0, 0)
    bone.Parent = workspace
    
    -- สั่งให้พาร์ทพุ่งไปหาเป้าหมาย
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = tweenService:Create(bone, info, {
        Position = targetHRP.Position + Vector3.new(math.random(-1,1), math.random(-1,1), math.random(-1,1)),
        Transparency = 1
    })
    
    tween:Play()
    game:GetService("Debris"):AddItem(bone, 0.3) -- ลบพาร์ททิ้งทันทีที่ถึงตัว
end

-- === [ ระบบเป้าล็อค ] ===
local function CreateTargetUI(targetPart)
    local highlight = Instance.new("Highlight")
    highlight.Name = "GasterTarget"
    highlight.FillColor = Color3.fromRGB(255, 255, 255) -- เปลี่ยนเป็นสีขาวแบบ Sans
    highlight.OutlineColor = Color3.fromRGB(0, 170, 255) -- ขอบฟ้าแบบตา Sans
    highlight.Parent = targetPart.Parent
    return highlight
end

-- === [ โครงสร้างหลัก ] ===
local SKILL_NAME = "GASTER BLASTER"

local function StartCooldownUI(toolName, duration)
    local tool = player.Backpack:FindFirstChild(toolName) or (player.Character and player.Character:FindFirstChild(toolName))
    if tool then
        task.spawn(function()
            for i = duration, 1, -1 do 
                if not tool.Parent then break end
                tool.Name = toolName .. " (" .. i .. "s)" 
                task.wait(1) 
            end
            if tool.Parent then tool.Name = toolName end
        end)
    end
end

local function CreateAttackTool(name, onAttackCallback)
    local backpack = player:WaitForChild("Backpack")
    local oldTool = backpack:FindFirstChild(name) or (player.Character and player.Character:FindFirstChild(name))
    if oldTool then oldTool:Destroy() end
    
    local tool = Instance.new("Tool")
    tool.Name = name
    tool.RequiresHandle = false
    tool.Parent = backpack
    tool.Activated:Connect(onAttackCallback)
end

local function GetNearestPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local myHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not myHRP then return nil end

    for _, p in ipairs(game:GetService("Players"):GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character.Humanoid.Health > 0 then
            local distance = (myHRP.Position - p.Character.HumanoidRootPart.Position).Magnitude
            if distance < 50 then -- ระยะล็อค 50 Studs
                if distance < shortestDistance then
                    shortestDistance = distance
                    closestPlayer = p.Character.HumanoidRootPart
                end
            end
        end
    end
    return closestPlayer
end

-- ฟังก์ชันกระหน่ำยิง (กระสุน Remote + สร้างกระดูกโชว์)
local function FireUltraBlast(targetHRP)
    if not targetHRP or not targetHRP.Parent then return end
    
    -- 1. สร้าง Effect กระดูกพุ่งใส่
    SummonBone(targetHRP)
    
    -- 2. ยิงดาเมจจริงผ่าน Remote ของปืนที่มี
    local guns = {}
    for _, item in ipairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and item.Name ~= SKILL_NAME then table.insert(guns, item) end
    end
    for _, item in ipairs(player.Character:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and item.Name ~= SKILL_NAME then table.insert(guns, item) end
    end
    
    for _, gun in ipairs(guns) do
        local remote = gun:FindFirstChild("shot") or gun:FindFirstChild("Fire")
        if remote then
            remote:FireServer(targetHRP.Position)
        end
    end
end

function RunCustomAnimation(Char)
    if not Char then return end
    local Humanoid = Char:WaitForChild("Humanoid", 10)
    local HRP = Char:WaitForChild("HumanoidRootPart", 10)
    
    if Char:FindFirstChild("Animate") then Char.Animate.Disabled = true end
    
    local isUsingSkill = false
    local currentAnimTrack = nil
    local lastState = "Idle"
    local cooldown = false

    local animTable = {}    
    local animNames = { 
        spawn = {{id = "rbxassetid://123627677663418"}}, 
        idle = {{id = "rbxassetid://123627677663418"}},  
        move = {{id = "rbxassetid://102622695004986"}},  
        gaster = {{id = "rbxassetid://113226933496361"}} 
    }

    for name, fileList in pairs(animNames) do
        animTable[name] = {count = 0}
        for idx, anim in pairs(fileList) do
            animTable[name][idx] = {anim = Instance.new("Animation")}
            animTable[name][idx].anim.AnimationId = anim.id
            animTable[name].count += 1
        end
    end

    local function playAnim(name, loop, speed)
        if not animTable[name] or not Humanoid then return end
        if currentAnimTrack then currentAnimTrack:Stop(0.1) end
        local idx = math.random(1, animTable[name].count)
        currentAnimTrack = Humanoid:LoadAnimation(animTable[name][idx].anim)
        currentAnimTrack.Looped = loop
        currentAnimTrack:Play(0.1)
        if speed then currentAnimTrack:AdjustSpeed(speed) end
        return currentAnimTrack
    end

    local function performGasterBlaster()
        if cooldown or isUsingSkill then return end
        
        local target = GetNearestPlayer()
        if not target then return end

        cooldown = true
        isUsingSkill = true
        StartCooldownUI(SKILL_NAME, 10)
        
        PlayMusic("406913243") 
        local skillTrack = playAnim("gaster", false)
        local targetUI = CreateTargetUI(target)

        task.spawn(function()
            -- ยิงรัวๆ 0.05 วินาทีต่อชุด จนกว่าอนิเมชั่นจะจบ
            while isUsingSkill and target and target.Parent do 
                FireUltraBlast(target) 
                task.wait(0.05) 
            end
            if targetUI then targetUI:Destroy() end
        end)

        if skillTrack then
            skillTrack.Ended:Connect(function()
                isUsingSkill = false
                StopMusic() 
                playAnim("idle", true)
            end)
        end
        
        task.delay(10, function() cooldown = false end)
    end

    CreateAttackTool(SKILL_NAME, performGasterBlaster)

    Humanoid.Running:Connect(function(speed)
        if isUsingSkill then return end
        if speed > 2 then 
            if lastState ~= "Moving" then lastState = "Moving" playAnim("move", true, 1.4) end
        else 
            if lastState ~= "Idle" then lastState = "Idle" playAnim("idle", true) end 
        end
    end)

    task.spawn(function()
        HRP.Anchored = true
        PlayMusic("4019097651") 
        local st = playAnim("spawn", false)
        if st then st.Ended:Wait() end
        HRP.Anchored = false
        playAnim("idle", true)
        StopMusic() 
    end)
end

if player.Character then task.spawn(function() RunCustomAnimation(player.Character) end) end
player.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    RunCustomAnimation(char)
end)
