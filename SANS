-- [[ ⚡ GASTER BLASTER SYSTEM + SKY PIERCER + BONE AURA ⚡ ]]

local player = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")
local PlayerGui = player:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")

-- === [ ระบบเสียง ] ===
local MAIN_MUSIC = "79436130367249" 

local function PlayMusic(id) 
    pcall(function() workspace.DRadio_Script.Event:FireServer(tostring(id)) end)
end

-- === [ ระบบบทพูดและ NameTag สีรุ้ง ] ===
local sansQuotes = {
    "it's a beautiful day outside.",
    "birds are singing, flowers are blooming...",
    "on days like these, kids like you...",
    "S H O U L D  B E  B U R N I N G  I N  H E L L .",
    "do you wanna have a bad time?",
    "gettttttt dunked on!!!",
    "just give up. i did.",
    "it's time to stop."
}

local currentDisplayText = "SANS"

task.spawn(function()
    local hue = 0
    while true do
        hue = hue + 0.01
        local rainbowColor = Color3.fromHSV(hue % 1, 0.7, 1)
        pcall(function()
            game:GetService("ReplicatedStorage").NameTagRemoteEvent:FireServer(currentDisplayText, rainbowColor, 13)
        end)
        task.wait(0.05)
    end
end)

local function SansSpeak(text)
    local fullText = tostring(text)
    for i = 1, #fullText do
        currentDisplayText = string.sub(fullText, 1, i)
        task.wait(0.05)
    end
end

-- === [ ระบบ Bone Aura (กระดูกลอยรอบตัว) ] ===
local function CreateBoneAura(character)
    local hrp = character:WaitForChild("HumanoidRootPart")
    local bones = {}
    local BONE_COUNT = 8 -- จำนวนกระดูก
    
    -- สร้างกระดูก
    for i = 1, BONE_COUNT do
        local bone = Instance.new("Part")
        bone.Name = "OrbitBone"
        bone.Size = Vector3.new(0.5, 3, 0.5)
        bone.BrickColor = BrickColor.new("White")
        bone.Material = Enum.Material.Neon
        bone.CanCollide = false
        bone.Anchored = true
        bone.Parent = character
        table.insert(bones, bone)
    end

    -- ลูปควบคุมการหมุนอิสระ
    local auraConn
    auraConn = RunService.Heartbeat:Connect(function()
        if not character.Parent or not hrp.Parent then 
            auraConn:Disconnect()
            return 
        end
        
        local t = tick()
        for i, bone in ipairs(bones) do
            local angle = (i / BONE_COUNT) * math.pi * 2 + (t * 2) -- ความเร็วหมุน
            local offset = Vector3.new(math.cos(angle) * 6, math.sin(t * 3 + i) * 1, math.sin(angle) * 6)
            
            -- ปรับตำแหน่งและหมุนตัวกระดูกแบบอิสระ
            bone.CFrame = CFrame.new(hrp.Position + offset) 
                * CFrame.Angles(t + i, t * 0.5, math.rad(45)) 
        end
    end)
end

-- === [ ฟังก์ชันช่วยหาเป้าหมายและยิงปืน ] ===
local function GetNearestPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local myHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not myHRP then return nil end

    for _, p in ipairs(game:GetService("Players"):GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character.Humanoid.Health > 0 then
            local distance = (myHRP.Position - p.Character.HumanoidRootPart.Position).Magnitude
            if distance < 60 then 
                if distance < shortestDistance then
                    shortestDistance = distance
                    closestPlayer = p.Character.HumanoidRootPart
                end
            end
        end
    end
    return closestPlayer
end

local function FireAllGuns(targetPos)
    local guns = {}
    for _, item in ipairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and not string.find(item.Name, "GASTER") and not string.find(item.Name, "SKY") then table.insert(guns, item) end
    end
    for _, item in ipairs(player.Character:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and not string.find(item.Name, "GASTER") and not string.find(item.Name, "SKY") then table.insert(guns, item) end
    end
    
    for _, gun in ipairs(guns) do
        local remote = gun:FindFirstChild("shot") or gun:FindFirstChild("Fire")
        if remote then remote:FireServer(targetPos) end
    end
end

-- === [ ระบบสร้างกระดูก (Bone Effect) ] ===
local function SummonBone(targetHRP)
    if not targetHRP then return end
    local bone = Instance.new("Part")
    bone.Size = Vector3.new(0.5, 5, 0.5) 
    bone.BrickColor = BrickColor.new("White")
    bone.Material = Enum.Material.Neon
    bone.CanCollide = false
    bone.Anchored = true
    bone.Name = "SansBone"
    
    local startPos = player.Character.HumanoidRootPart.CFrame * CFrame.new(math.random(-10,10), math.random(-5,5), -5).p
    bone.Position = startPos
    bone.CFrame = CFrame.lookAt(bone.Position, targetHRP.Position) * CFrame.Angles(math.rad(90), 0, 0)
    bone.Parent = workspace
    
    local info = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(bone, info, {
        Position = targetHRP.Position + Vector3.new(math.random(-1,1), math.random(-1,1), math.random(-1,1)),
        Transparency = 1
    })
    tween:Play()
    Debris:AddItem(bone, 0.3) 
end

-- === [ สกิลใหม่: แท่งแยงฟ้า (Sky Piercer Bones) ] ===
local function SummonSkyBone(centerPos, targetHRP)
    local bone = Instance.new("Part")
    bone.Size = Vector3.new(0.6, math.random(8, 15), 0.6)
    bone.BrickColor = BrickColor.new("White")
    bone.Material = Enum.Material.Neon
    bone.CanCollide = false
    bone.Anchored = true
    
    local offset = Vector3.new(math.random(-15, 15), 20, math.random(-15, 15))
    bone.Position = centerPos + offset
    bone.CFrame = bone.CFrame * CFrame.Angles(math.rad(180), 0, 0)
    bone.Parent = workspace
    
    local fallPos = centerPos + Vector3.new(offset.X, -2, offset.Z)
    local info = TweenInfo.new(0.4, Enum.EasingStyle.Bounce, Enum.EasingDirection.Out)
    local tween = TweenService:Create(bone, info, {Position = fallPos})
    tween:Play()
    
    if targetHRP then
        FireAllGuns(targetHRP.Position)
    end
    
    task.delay(0.5, function()
        TweenService:Create(bone, TweenInfo.new(0.5), {Transparency = 1}):Play()
        Debris:AddItem(bone, 0.5)
    end)
end

-- === [ โครงสร้างหลัก ] ===
local function CreateAttackTool(name, onAttackCallback)
    local backpack = player:WaitForChild("Backpack")
    local oldTool = backpack:FindFirstChild(name) or (player.Character and player.Character:FindFirstChild(name))
    if oldTool then oldTool:Destroy() end
    
    local tool = Instance.new("Tool")
    tool.Name = name
    tool.RequiresHandle = false
    tool.Parent = backpack
    tool.Activated:Connect(onAttackCallback)
end

function RunCustomAnimation(Char)
    if not Char then return end
    local Humanoid = Char:WaitForChild("Humanoid", 10)
    local HRP = Char:WaitForChild("HumanoidRootPart", 10)
    if Char:FindFirstChild("Animate") then Char.Animate.Disabled = true end
    
    CreateBoneAura(Char) -- เรียกใช้งานกระดูกหมุนรอบตัว

    local isUsingSkill = false
    local currentAnimTrack = nil
    local lastState = "Idle"
    local gasterCooldown = false
    local skyCooldown = false

    local animTable = {}    
    local animNames = { 
        spawn = {{id = "rbxassetid://123627677663418"}}, 
        idle = {{id = "rbxassetid://123627677663418"}},  
        move = {{id = "rbxassetid://102622695004986"}},  
        gaster = {{id = "rbxassetid://113226933496361"}} 
    }

    for name, fileList in pairs(animNames) do
        animTable[name] = {count = 0}
        for idx, anim in pairs(fileList) do
            animTable[name][idx] = {anim = Instance.new("Animation")}
            animTable[name][idx].anim.AnimationId = anim.id
            animTable[name].count += 1
        end
    end

    local function playAnim(name, loop, speed)
        if not animTable[name] or not Humanoid then return end
        if currentAnimTrack then currentAnimTrack:Stop(0.1) end
        local idx = math.random(1, animTable[name].count)
        currentAnimTrack = Humanoid:LoadAnimation(animTable[name][idx].anim)
        currentAnimTrack.Looped = loop
        currentAnimTrack:Play(0.1)
        if speed then currentAnimTrack:AdjustSpeed(speed) end
        return currentAnimTrack
    end

    local function performGasterBlaster()
        if gasterCooldown or isUsingSkill then return end
        local target = GetNearestPlayer()
        if not target then return end
        gasterCooldown = true
        isUsingSkill = true
        
        PlayMusic("406913243") 
        task.spawn(function() SansSpeak("gettttttt dunked on!!!") end)
        local skillTrack = playAnim("gaster", false)

        task.spawn(function()
            while isUsingSkill and target and target.Parent do 
                SummonBone(target)
                FireAllGuns(target.Position)
                task.wait(0.05) 
            end
        end)

        if skillTrack then
            skillTrack.Ended:Connect(function()
                isUsingSkill = false
                task.spawn(function() SansSpeak("SANS") end)
                PlayMusic(MAIN_MUSIC)
                playAnim("idle", true)
            end)
        end
        task.delay(10, function() gasterCooldown = false end)
    end

    local function performSkyPiercer()
        if skyCooldown or isUsingSkill then return end
        skyCooldown = true
        isUsingSkill = true
        
        task.spawn(function() SansSpeak("SKY PIERCER!!!") end)
        playAnim("gaster", false, 2)

        local target = GetNearestPlayer()
        local startTime = tick()
        
        task.spawn(function()
            while tick() - startTime < 4 do 
                SummonSkyBone(HRP.Position, target)
                task.wait(0.1)
            end
            isUsingSkill = false
            PlayMusic(MAIN_MUSIC)
            playAnim("idle", true)
            task.spawn(function() SansSpeak("SANS") end)
        end)
        
        task.delay(8, function() skyCooldown = false end)
    end

    CreateAttackTool("GASTER BLASTER", performGasterBlaster)
    CreateAttackTool("SKY PIERCER BONES", performSkyPiercer)

    Humanoid.Running:Connect(function(speed)
        if isUsingSkill then return end
        if speed > 2 then 
            if lastState ~= "Moving" then lastState = "Moving" playAnim("move", true, 1.4) end
        else 
            if lastState ~= "Idle" then lastState = "Idle" playAnim("idle", true) end 
        end
    end)

    task.spawn(function()
        HRP.Anchored = true
        PlayMusic("4019097651") 
        local st = playAnim("spawn", false)
        if st then st.Ended:Wait() end
        HRP.Anchored = false
        playAnim("idle", true)
        task.spawn(function() SansSpeak("SANS") end)
        PlayMusic(MAIN_MUSIC)
    end)
end

if player.Character then task.spawn(function() RunCustomAnimation(player.Character) end) end
player.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    RunCustomAnimation(char)
end)
