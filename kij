-- [[ ⚡ KJ TRIPLE TOOL SYSTEM (FIXED MOVEMENT AFTER SPAWN) ⚡ ]]

local player = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local PlayerGui = player:WaitForChild("PlayerGui")
local Camera = workspace.CurrentCamera

-- === [ ระบบ Cinematic UI ] ===
local function CreateCinematicUI()
    local existing = PlayerGui:FindFirstChild("CinematicUI")
    if existing then existing:Destroy() end

    local sg = Instance.new("ScreenGui")
    sg.Name = "CinematicUI"
    sg.IgnoreGuiInset = true
    sg.Parent = PlayerGui

    local topBar = Instance.new("Frame")
    topBar.Name = "TopBar"
    topBar.Size = UDim2.new(1, 0, 0.15, 0)
    topBar.Position = UDim2.new(0, 0, -0.15, 0)
    topBar.BackgroundColor3 = Color3.new(0, 0, 0)
    topBar.BorderSizePixel = 0
    topBar.Parent = sg

    local bottomBar = topBar:Clone()
    bottomBar.Name = "BottomBar"
    bottomBar.Position = UDim2.new(0, 0, 1, 0)
    bottomBar.Parent = sg

    local subtitle = Instance.new("TextLabel")
    subtitle.Name = "Subtitle"
    subtitle.Size = UDim2.new(1, 0, 0.6, 0)
    subtitle.Position = UDim2.new(0, 0, 0.2, 0)
    subtitle.BackgroundTransparency = 1
    subtitle.TextColor3 = Color3.new(1, 1, 1)
    subtitle.Font = Enum.Font.SourceSansBold
    subtitle.TextSize = 28
    subtitle.Text = ""
    subtitle.Parent = bottomBar

    return topBar, bottomBar, subtitle
end

local topBar, bottomBar, subtitle = CreateCinematicUI()

local function PlayCinematic(text)
    topBar:TweenPosition(UDim2.new(0, 0, 0, 0), "Out", "Quad", 0.5, true)
    bottomBar:TweenPosition(UDim2.new(0, 0, 0.85, 0), "Out", "Quad", 0.5, true)
    task.wait(0.5)
    subtitle.Text = ""
    for i = 1, #text do 
        subtitle.Text = string.sub(text, 1, i) 
        task.wait(0.04) 
    end
    task.wait(1.5)
    subtitle.Text = ""
    topBar:TweenPosition(UDim2.new(0, 0, -0.15, 0), "In", "Quad", 0.5, true)
    bottomBar:TweenPosition(UDim2.new(0, 0, 1, 0), "In", "Quad", 0.5, true)
end

-- === [ ระบบเสียง ] ===
local function PlayMusic(id) 
    pcall(function() workspace.DRadio_Script.Event:FireServer(tostring(id)) end)
end

local function StopMusic() 
    pcall(function() workspace.DRadio_Script.STOPEvent:FireServer() end)
end

-- === [ โครงสร้างหลัก ] ===
local SKILL_1_NAME = "20-20-20 DROPKICK"
local SKILL_2_NAME = "UNLIMITED FLEX WORKS"
local SKILL_3_NAME = "STOIC BOMB"

local function StartCooldownUI(toolName, duration)
    local tool = player.Backpack:FindFirstChild(toolName) or (player.Character and player.Character:FindFirstChild(toolName))
    if tool then
        task.spawn(function()
            for i = duration, 1, -1 do 
                if not tool.Parent then break end
                tool.Name = toolName .. " (" .. i .. "s)" 
                task.wait(1) 
            end
            if tool.Parent then tool.Name = toolName end
        end)
    end
end

local function CreateAttackTool(name, onAttackCallback)
    local backpack = player:WaitForChild("Backpack")
    local oldTool = backpack:FindFirstChild(name) or (player.Character and player.Character:FindFirstChild(name))
    if oldTool then oldTool:Destroy() end
    
    local tool = Instance.new("Tool")
    tool.Name = name
    tool.RequiresHandle = false
    tool.CanBeDropped = false
    tool.Parent = backpack
    tool.Activated:Connect(onAttackCallback)
end

local function FireUltraBlast(targetHRP)
    if not targetHRP or not targetHRP.Parent then return end
    local guns = {}
    for _, item in ipairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and item.Name ~= SKILL_2_NAME and item.Name ~= "Phone" then table.insert(guns, item) end
    end
    for _, item in ipairs(player.Character:GetChildren()) do
        if item:IsA("Tool") and not string.find(item.Name, "KJ") and item.Name ~= SKILL_2_NAME and item.Name ~= "Phone" then table.insert(guns, item) end
    end
    for _, gun in ipairs(guns) do
        local remote = gun:FindFirstChild("shot") or gun:FindFirstChild("Fire")
        if remote then
            for i = 1, 3 do remote:FireServer(targetHRP.Position) end
        end
    end
end

function RunCustomAnimation(Char)
    if not Char then return end
    local Humanoid = Char:WaitForChild("Humanoid", 10)
    local HRP = Char:WaitForChild("HumanoidRootPart", 10)
    if not Humanoid or not HRP then return end
    
    -- แก้ไข: ปลดล็อกสถานะทันทีเมื่อฟังก์ชันเริ่มทำงาน
    if Char:FindFirstChild("Animate") then Char.Animate.Disabled = true end
    HRP.Anchored = false
    Humanoid.WalkSpeed = 16

    local isRushing = false
    local isPerformingUltimate = false
    local isStoicActive = false
    local actionTrack = nil
    local currentAnimTrack = nil
    local lastState = "Idle"
    local cooldowns = {[SKILL_1_NAME] = false, [SKILL_2_NAME] = false, [SKILL_3_NAME] = false}

    local RootJoint = HRP:FindFirstChild("RootJoint", true)
    local RootCF = CFrame.fromEulerAnglesXYZ(-math.pi/2, 0, math.pi)

    local flexConn = RunService.RenderStepped:Connect(function()
        if not HRP.Parent or not RootJoint then return end
        if (not actionTrack or not actionTrack.IsPlaying) and not isPerformingUltimate and not isStoicActive then
            local moveSpeed = Humanoid.MoveDirection.Magnitude
            local sine = tick() * 12
            if moveSpeed > 0.1 then
                local walkFlex = CFrame.new(0, math.sin(sine) * 0.15, 0) * CFrame.Angles(math.rad(math.sin(sine) * 20), 0, math.rad(math.sin(sine) * 5))
                RootJoint.C0 = RootJoint.C0:Lerp(RootCF * walkFlex, 0.2)
            else
                local idleFlex = CFrame.new(0, math.sin(sine/2) * 0.05, 0) * CFrame.Angles(0, math.rad(math.sin(sine/2) * 4), 0)
                RootJoint.C0 = RootJoint.C0:Lerp(RootCF * idleFlex, 0.1)
            end
        end
    end)

    local animTable = {}    
    local animNames = { 
        spawn = {{id = "rbxassetid://129225170899725"}},
        idle = {{id = "rbxassetid://72492959889389"}},
        walk = {{id = "rbxassetid://82741102191749"}},
        run = {{id = "rbxassetid://82741102191749"}},
        rush_run = {{id = "rbxassetid://101871663749983"}}, 
        dropkick = {{id = "rbxassetid://133566007754001"}},
        ultimate = {{id = "rbxassetid://139302979952874"}},
        stoic = {{id = "rbxassetid://110863385954626"}}
    }

    for name, fileList in pairs(animNames) do
        animTable[name] = {count = 0}
        for idx, anim in pairs(fileList) do
            animTable[name][idx] = {anim = Instance.new("Animation")}
            animTable[name][idx].anim.AnimationId = anim.id
            animTable[name].count += 1
        end
    end

    local function playAnim(name, loop, speed)
        if not animTable[name] or not Humanoid then return end
        if currentAnimTrack then currentAnimTrack:Stop(0.1) end
        local idx = math.random(1, animTable[name].count)
        currentAnimTrack = Humanoid:LoadAnimation(animTable[name][idx].anim)
        currentAnimTrack.Looped = loop
        currentAnimTrack:Play(0.1)
        if speed then currentAnimTrack:AdjustSpeed(speed) end
        return currentAnimTrack
    end

    -- === [ Skill Functions ] ===
    
    local function performStoicBomb()
        if cooldowns[SKILL_3_NAME] or isRushing or isPerformingUltimate or isStoicActive then return end
        cooldowns[SKILL_3_NAME] = true
        isStoicActive = true
        StartCooldownUI(SKILL_3_NAME, 15)
        PlayMusic("104398439636356")
        
        local originalPos = HRP.Position
        local floatPart = Instance.new("BodyVelocity")
        floatPart.Velocity = Vector3.new(0, 0, 0)
        floatPart.MaxForce = Vector3.new(0, math.huge, 0)
        floatPart.Parent = HRP

        HRP.CFrame = HRP.CFrame * CFrame.new(0, 100, 0)
        TweenService:Create(HRP, TweenInfo.new(3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {CFrame = CFrame.new(originalPos + Vector3.new(0, 6, 0))}):Play()

        local stoicTrack = playAnim("stoic", true)
        task.wait(9.5) 
        
        if stoicTrack then stoicTrack:Stop(0.5) end
        floatPart:Destroy()
        StopMusic()
        isStoicActive = false
        Humanoid.WalkSpeed = 16
        playAnim("idle", true)
        task.delay(5.5, function() cooldowns[SKILL_3_NAME] = false end)
    end

    local function performRushAttack()
        if cooldowns[SKILL_1_NAME] or isRushing or isPerformingUltimate or isStoicActive then return end
        cooldowns[SKILL_1_NAME] = true
        isRushing = true
        StartCooldownUI(SKILL_1_NAME, 8) 
        PlayMusic("17729337538")
        
        local rushTrack = playAnim("rush_run", true, 2.2)
        local autoMoveConn
        autoMoveConn = RunService.Heartbeat:Connect(function()
            if isRushing and HRP.Parent then 
                Humanoid:Move(Vector3.new(0, 0, -1), true) 
                Humanoid.WalkSpeed = 150
                HRP.CFrame = CFrame.lookAt(HRP.Position, HRP.Position + Vector3.new(Camera.CFrame.LookVector.X, 0, Camera.CFrame.LookVector.Z))
            else autoMoveConn:Disconnect() end
        end)

        local touchConn
        touchConn = HRP.Touched:Connect(function(hit)
            local targetChar = hit.Parent
            local targetHum = targetChar:FindFirstChildOfClass("Humanoid")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            if targetHum and targetHRP and targetChar ~= Char and isRushing then
                isRushing = false
                touchConn:Disconnect()
                rushTrack:Stop()
                PlayMusic("92231886696392")
                actionTrack = Humanoid:LoadAnimation(animTable["dropkick"][1].anim)
                actionTrack:Play(0.1)
                
                local followConn
                followConn = RunService.RenderStepped:Connect(function()
                    if actionTrack and actionTrack.IsPlaying and targetHRP.Parent then
                        Humanoid.WalkSpeed = 0
                        HRP.CFrame = CFrame.lookAt(targetHRP.Position + (targetHRP.CFrame.LookVector * 3.5), targetHRP.Position)
                    else followConn:Disconnect() end
                end)
                
                task.spawn(function()
                    while actionTrack and actionTrack.IsPlaying and targetHum.Health > 0 do
                        FireUltraBlast(targetHRP)
                        task.wait(0.05)
                    end
                end)
                actionTrack.Stopped:Connect(function() 
                    Humanoid.WalkSpeed = 16 
                    playAnim("idle", true) 
                    StopMusic() 
                end)
            end
        end)
        
        task.delay(8, function() 
            if isRushing then 
                isRushing = false 
                if rushTrack then rushTrack:Stop() end
                Humanoid.WalkSpeed = 16 
                playAnim("idle", true) 
                StopMusic() 
            end 
            task.wait(1)
            cooldowns[SKILL_1_NAME] = false
        end)
    end

    local function performUltimate()
        if isPerformingUltimate or cooldowns[SKILL_2_NAME] or isRushing or isStoicActive then return end
        cooldowns[SKILL_2_NAME] = true
        isPerformingUltimate = true
        StartCooldownUI(SKILL_2_NAME, 20)
        Humanoid.WalkSpeed = 0
        
        local atkTrack = Humanoid:LoadAnimation(animTable["ultimate"][1].anim)
        atkTrack:Play(0.1)
        
        local camConn = RunService.RenderStepped:Connect(function()
            if isPerformingUltimate and HRP.Parent then
                local head = Char:FindFirstChild("Head")
                Camera.CameraType = Enum.CameraType.Scriptable
                if head then
                    local camPos = HRP.Position + (HRP.CFrame.LookVector * 6) + Vector3.new(0, 1.5, 0)
                    Camera.CFrame = CFrame.new(camPos + Vector3.new(math.random(-1,1)/10, math.random(-1,1)/10, math.random(-1,1)/10), head.Position)
                end
            else
                Camera.CameraType = Enum.CameraType.Custom
            end
        end)

        atkTrack.Stopped:Connect(function()
            task.spawn(function()
                local loopTrack = Humanoid:LoadAnimation(animTable["ultimate"][1].anim)
                loopTrack:Play(0.2)
                loopTrack:AdjustSpeed(0.5)
                local start = tick()
                while tick() - start < 20 and isPerformingUltimate and Humanoid.Health > 0 do
                    for _, p in ipairs(game:GetService("Players"):GetPlayers()) do
                        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then 
                            FireUltraBlast(p.Character.HumanoidRootPart) 
                        end
                    end
                    task.wait(0.1)
                end
                loopTrack:Stop(0.5)
                isPerformingUltimate = false
                camConn:Disconnect()
                Camera.CameraType = Enum.CameraType.Custom
                Humanoid.WalkSpeed = 16
                playAnim("idle", true)
                StopMusic()
            end)
        end)
        task.delay(20, function() cooldowns[SKILL_2_NAME] = false end)
    end

    -- === [ Setup ] ===
    CreateAttackTool(SKILL_1_NAME, performRushAttack)
    CreateAttackTool(SKILL_2_NAME, performUltimate)
    CreateAttackTool(SKILL_3_NAME, performStoicBomb)

    Humanoid.Running:Connect(function(speed)
        if isRushing or (actionTrack and actionTrack.IsPlaying) or isPerformingUltimate or isStoicActive then return end
        if speed > 2 then 
            if lastState ~= "Running" then lastState = "Running" playAnim("run", true, 1.2) end
        else 
            if lastState ~= "Idle" then lastState = "Idle" playAnim("idle", true) end 
        end
    end)

    -- [ Clean up on Death ]
    Humanoid.Died:Connect(function()
        flexConn:Disconnect()
        isRushing = false
        isPerformingUltimate = false
        isStoicActive = false
        HRP.Anchored = false -- ป้องกันการเกิดค้าง
        StopMusic()
        Camera.CameraType = Enum.CameraType.Custom
    end)

    -- [ Spawn Logic ]
    task.spawn(function()
        Humanoid.WalkSpeed = 0
        HRP.Anchored = true
        PlayMusic("111572591472056")
        local st = playAnim("spawn", false)
        
        -- เล่น Cinematic
        task.spawn(function()
            PlayCinematic("The legend has awakened.")
        end)
        
        -- แก้ไข: รอจนจบหรือถ้าบัคให้ข้าม
        if st then 
            st.Ended:Wait() 
        else
            task.wait(3) -- Fallback ถ้าโหลดอนิเมชั่นไม่สำเร็จ
        end
        
        -- แก้ไข: บังคับปลดล็อกที่นี่แน่นอน
        HRP.Anchored = false
        Humanoid.WalkSpeed = 16
        playAnim("idle", true)
        StopMusic()
    end)
end

-- Initial Start
if player.Character then task.spawn(function() RunCustomAnimation(player.Character) end) end
player.CharacterAdded:Connect(function(char)
    task.wait(0.5) -- รอให้ Character โหลดสมบูรณ์เล็กน้อย
    RunCustomAnimation(char)
end)
